---
title: ã€é¢è¯•é¢˜ã€‘node
date: 2021-03-29 18:50:57
categories: node
tags: [node, é¢è¯•]
---

### node äº‹ä»¶å¾ªç¯

Node 10 åŠä»¥å‰:

![Node äº‹ä»¶å¾ªç¯](./ã€é¢è¯•é¢˜ã€‘node/libuv.png)
Libuv æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ï¼Œäº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥ I/O åº“ï¼Œå®ƒæœ¬èº«æ˜¯ç”± C è¯­è¨€ç¼–å†™çš„ï¼Œå…·æœ‰å¾ˆé«˜çš„å¯ç§»æ¤æ€§ã€‚
**äº‹ä»¶å¾ªç¯çš„ 7 ä¸ªä¸»è¦é˜¶æ®µ**
**timesï¼š** setTimeout setInterval å›è°ƒ
**I/O callbacksï¼š** å¤„ç†å¼‚æ­¥äº‹ä»¶çš„å›è°ƒï¼Œæ¯”å¦‚ç½‘ç»œ I/Oï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å– I/Oã€‚å½“è¿™äº› I/O åŠ¨ä½œéƒ½**ç»“æŸ**çš„æ—¶å€™ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä¼šè§¦å‘å®ƒä»¬çš„å›è°ƒã€‚ï¼ˆä¸Šä¸€è½®å¾ªç¯çš„å›è°ƒï¼‰
**idle, prepareï¼š** è¿™ä¸ªé˜¶æ®µå†…éƒ¨åšä¸€äº›åŠ¨ä½œï¼Œä»… node å†…éƒ¨ä½¿ç”¨
**I/O poll é˜¶æ®µï¼š** è·å–æ–°çš„ I/O äº‹ä»¶ï¼Œé€‚å½“çš„æ¡ä»¶ä¸‹ node å°†é˜»å¡åœ¨è¿™é‡Œ
**checkï¼š** æ‰§è¡Œ setImmediate() å›è°ƒ
**close callbackï¼š** å…³é—­ I/O çš„åŠ¨ä½œï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦çš„å…³é—­ï¼Œsocket æ–­å¼€ï¼Œç­‰ç­‰ç­‰

> process.nextTick çš„æ“ä½œï¼Œä¼šåœ¨æ¯ä¸€è½®äº‹ä»¶å¾ªç¯çš„æœ€åæ‰§è¡Œ

- æ‰§è¡Œå…¨å±€ Script çš„åŒæ­¥ä»£ç 
- æ‰§è¡Œ microtask å¾®ä»»åŠ¡ï¼Œå…ˆæ‰§è¡Œæ‰€æœ‰ Next Tick Queue ä¸­çš„æ‰€æœ‰ä»»åŠ¡
- åœ¨æ‰§è¡Œ Other Microtask Queue ä¸­çš„æ‰€æœ‰ä»»åŠ¡
- æ‰§è¡Œå®Œæˆä¹‹åå¼€å§‹æ‰§è¡Œ macrotask å®ä»»åŠ¡ï¼Œå…± 6 ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µçº¢ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œå†æ‰§è¡Œ æ­¥éª¤ 2 ï¼Œç„¶åç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªé˜¶æ®µçš„å®ä»»åŠ¡ï¼Œå†æ‰§è¡Œ æ­¥éª¤ 2ã€‚
- å¦‚ï¼šTimes Queue -> æ­¥éª¤ 2 -> I/O Queue -> æ­¥éª¤ 2 -> Check Queue -> æ­¥éª¤ 2 -> Close Callback -> æ­¥éª¤ 2 -> Times Queue -> ...
- è¿™å°±æ˜¯ Node çš„ Event Loop

Node 11 ä»¥å:
ç±»ä¼¼æµè§ˆå™¨äº‹ä»¶å¾ªç¯

### ä»‹ç»ä»¥ä¸‹ nodejs ä¸­é—´ä»¶

ä¸­é—´ä»¶ä¸»è¦æ˜¯æŒ‡å°è£… http è¯·æ±‚ç»†èŠ‚å¤„ç†çš„æ–¹æ³•ã€‚å¼•å…¥äº† Node ä¸­é—´ä»¶æ¥ç®€åŒ–å’Œå°è£…è¿™äº›åŸºç¡€é€»è¾‘å¤„ç†ç»†èŠ‚ã€‚

### node æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Node.js
- é¿å…ä½¿ç”¨åŒæ­¥ä»£ç 
- ç¼“å­˜é™æ€æ–‡ä»¶
- ä½¿ç”¨ gzip
- å®ç° SSL/TLS å’Œ HTTP/2
- è¯»å†™åˆ†ç¦»
- å¤šè¿›ç¨‹æ¶æ„

### node é”™è¯¯ç›‘æ§

- è¯­æ³•é”™è¯¯ï¼Œè¿è¡Œæ—¶é”™è¯¯è§¦å‘ JavaScript error
- è®¿é—®ä¸å­˜åœ¨çš„æ–‡ä»¶è§¦å‘ç³»ç»Ÿé”™è¯¯ã€‚
- è‡ªå®šä¹‰ error

**æ—¥å¿—**

- nginx log
- log4js
- pm2 log

### koa2 ä¸­é—´ä»¶åŸç†ã€‚

ğŸ§… æ´‹è‘±æ¨¡å‹
é€šè¿‡ use() æ³¨å†Œå¤šä¸ªä¸­é—´ä»¶æ”¾å…¥æ•°ç»„ä¸­ï¼Œä»å¤–å±‚å¼€å§‹å¾€å†…æ‰§è¡Œï¼Œé‡åˆ° next()æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ‰€æœ‰ä¸­é—´ä»¶æ‰§è¡Œå®Œæˆä¹‹åï¼Œå¼€å§‹è¿”å›ï¼Œä¸€æ¬¡æ‰§è¡Œä¸­é—´ä»¶æœªæ‰§è¡Œçš„éƒ¨åˆ†ã€‚

### node å¦‚ä½•è¿›è¡Œè·¨åŸŸé€šä¿¡

Node è®¾ç½®å…è®¸è·¨åŸŸ

```js
res.header("Access-Control-Allow-Origin", "https://www.daiwei.site");
```

### require åŸç†

```js
let name = require("./a");
console.log(name);
```

ä¸Šè¿°ä»£ç å¼•å…¥ `a.js` æ–‡ä»¶æ—¶å€™ï¼Œå†…éƒ¨å¤§è‡´å‘ç”Ÿçš„æµç¨‹å¦‚ä¸‹:

- å°† `./a` è½¬åŒ–ä¸ºç»å¯¹è·¯å¾„ï¼Œå¹¶ä¸”è¡¥å……åç¼€å(`c:\Users\chenying\Desktop\code\a.js`)
- æ ¹æ®ç»å¯¹è·¯å¾„åˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ç¼“å­˜çš„æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨åˆ™å–ç¼“å­˜ï¼Œä¸å­˜åœ¨åˆ™ç»§ç»­
- åˆ›å»º `Module` å®ä¾‹ `module`ï¼Œå°†ç»å¯¹è·¯å¾„ä¼ å…¥
- å–å¾—ç»å¯¹è·¯å¾„çš„åç¼€åï¼Œæ ¹æ®åç¼€å(`.js`)è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°
- è¯» `.js` å’Œ `.json` æ–‡ä»¶æ€è·¯å¤§åŒå°å¼‚ï¼Œé€šè¿‡ fs.readFileSync()è¯»å–æ–‡ä»¶å†…å®¹
- å¯¹è¯»åˆ°çš„ `.js` æ–‡ä»¶çš„å†…å®¹å¤–å±‚åŒ…è£¹ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å°†å­—ç¬¦ä¸²è½¬æˆå‡½æ•°æ‰§è¡Œ
- å¯¹è¯»åˆ°çš„ `.json` æ–‡ä»¶çš„å†…å®¹ï¼Œè½¬ä¸ºå¯¹è±¡ï¼Œå¹¶ä¸”èµ‹å€¼ç»™`module.exports`

### node å¼‚å¸¸å¤„ç†

- ä½¿ç”¨ `try catch` æ–¹å¼æ¥å¤„ç†å¼‚å¸¸
  > `try catch` æ— æ³•å¤„ç†å¼‚æ­¥ä»£ç å—å†…å‡ºç°çš„å¼‚å¸¸
- ä½¿ç”¨ `event` æ–¹å¼æ¥å¤„ç†å¼‚å¸¸

  ```js
  const events = require("events");
  // åˆ›å»ºä¸€ä¸ªäº‹ä»¶ç›‘å¬å¯¹è±¡
  const emitter = new events.EventEmitter();
  // ç›‘å¬erroräº‹ä»¶
  emitter.addListener("error", (e) => {
    // å¤„ç†å¼‚å¸¸ä¿¡æ¯
    console.log(11122222); // èƒ½æ‰“å° 1112222 è¯´æ˜å¼‚å¸¸æ•è·åˆ°äº†
    console.log(e);
  });
  // è§¦å‘ erroräº‹ä»¶
  emitter.emit("error", new Error("ä½ ä»£ç å‡ºé”™äº†"));
  ```

- è‡ªå¸¦çš„ `error first callback` çš„æ–¹å¼
- `Promise` `catch` æ–¹å¼
- `process` æ–¹å¼ `uncaughtException`

  ```js
  process.on("uncaughtException", (e) => {
    console.log("æˆ‘èƒ½è¿›æ¥ï¼Œè¯´æ˜å¯ä»¥å¤„ç†å¼‚å¸¸");
    console.log(e);
  });

  function testFunc() {
    throw new Error("error");
  }

  testFunc();
  ```
